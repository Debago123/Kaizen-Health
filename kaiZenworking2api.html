<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KaiZen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2c2c2c;
            --tertiary-bg: #444;
            --primary-text: #f0f0f0;
            --secondary-text: #a0a0a0;
            --accent-color: #4ade80; /* Green */
            --negative-color: #f87171; /* Red */
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Main App Layout --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            overflow-y: auto;
            transition: margin-right 0.3s ease;
        }
        
        .main-content.sidebar-open {
            margin-right: 300px;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .total-score-display {
            background-color: var(--secondary-bg);
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* --- Core Interaction Area --- */
        .game-area {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            background-color: var(--secondary-bg);
            padding: 2rem;
            border-radius: 1rem;
        }

        @media (min-width: 768px) {
            .game-area {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .upload-section, .result-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 1.5rem;
        }
        
        .image-preview-container {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1 / 1;
            background-color: var(--primary-bg);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px dashed var(--tertiary-bg);
            margin-bottom: 1rem;
        }
        
        #image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .placeholder-text {
            color: var(--secondary-text);
            text-align: center;
        }

        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn {
            border: none;
            color: var(--primary-bg);
            background-color: var(--accent-color);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn:hover {
            background-color: #36b368;
        }
        .btn.secondary {
            background-color: var(--tertiary-bg);
            color: var(--primary-text);
        }
        .btn.secondary:hover {
            background-color: #555;
        }
        .btn:disabled {
            background-color: var(--tertiary-bg);
            cursor: not-allowed;
            opacity: 0.7;
        }


        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .divider {
            width: 80%;
            height: 1px;
            background-color: var(--tertiary-bg);
            margin: 1rem 0;
        }

        .manual-entry-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 300px;
            align-items: center;
        }

        #food-select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: none;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            font-size: 1rem;
        }
        
        .manual-entry-buttons {
            display: flex;
            gap: 0.5rem;
            width: 100%;
        }
        .manual-entry-buttons .btn {
            flex-grow: 1;
        }


        /* --- Results Display --- */
        .result-section {
            gap: 1rem;
            align-items: stretch;
            text-align: center;
        }

        #result-food-name {
            font-size: 1.75rem;
            font-weight: 700;
            text-transform: capitalize;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
        }

        .nutrition-item {
            background-color: var(--tertiary-bg);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .nutrition-item .label {
            font-size: 0.9rem;
            color: var(--secondary-text);
        }
        .nutrition-item .value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        #result-points {
            font-size: 2rem;
            font-weight: 700;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        .loader {
            border: 4px solid var(--tertiary-bg);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background-color: var(--secondary-bg);
            padding: 1.5rem;
            height: 100%;
            position: fixed;
            top: 0;
            right: -300px; /* Initially hidden */
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar h2 {
            font-size: 1.5rem;
            word-wrap: break-word;
        }

        #group-id-display {
            font-size: 0.9rem;
            color: var(--secondary-text);
            background: var(--primary-bg);
            padding: 0.5rem;
            border-radius: 0.25rem;
            word-break: break-all;
            cursor: pointer;
        }

        #group-leaderboard {
            list-style-type: none;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #group-leaderboard li {
            display: flex;
            justify-content: space-between;
            background-color: var(--tertiary-bg);
            padding: 0.75rem;
            border-radius: 0.375rem;
        }
        #group-leaderboard li.is-user {
            border: 2px solid var(--accent-color);
        }

        .sidebar-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 110;
            background: var(--secondary-bg);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar-toggle svg {
            width: 28px;
            height: 28px;
            stroke: var(--primary-text);
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; 
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-modal-btn {
            background: none;
            border: none;
            color: var(--primary-text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        #add-food-form, #group-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            color: var(--secondary-text);
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 0.75rem;
            border: 1px solid var(--tertiary-bg);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            border-radius: 0.375rem;
            width: 100%;
        }
        
        .modal-content .btn {
            grid-column: 1 / -1;
            margin-top: 1rem;
        }
        #group-form .btn { margin-top: 0.5rem; }
        #group-form .divider { margin: 0.5rem 0; width: 100%;}

        /* --- Notification System --- */
        #notification-area {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .notification {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            font-weight: 600;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(100%);
            animation: slideUp 0.3s forwards, fadeOut 0.5s 3s forwards;
        }
        .notification.error {
            background-color: var(--negative-color);
            color: var(--primary-text);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

    </style>
</head>
<body>
    <div id="notification-area"></div>
    <div id="loading-overlay" class="modal-overlay visible">
        <div class="loader"></div>
    </div>
    <div class="app-container">
        
        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <header class="header">
                <h1>KaiZen</h1>
                <div class="total-score-display">
                    <span>Your Score:</span>
                    <span id="total-score">0</span>
                </div>
            </header>

            <section class="game-area">
                <div class="upload-section">
                    <div class="image-preview-container">
                        <img id="image-preview" src="" alt="Image preview">
                        <div id="placeholder-text" class="placeholder-text">
                            <p>Upload a picture of your meal</p>
                        </div>
                    </div>
                    <div class="upload-btn-wrapper">
                        <button class="btn">Upload Image</button>
                        <input type="file" id="image-upload" accept="image/*">
                    </div>
                    
                    <div class="divider"></div>

                    <div class="manual-entry-section">
                        <p>Or log manually</p>
                        <select id="food-select"></select>
                        <div class="manual-entry-buttons">
                           <button class="btn" id="log-selected-food-btn">Log Food</button>
                           <button class="btn secondary" id="add-custom-food-btn">Add New</button>
                        </div>
                    </div>
                </div>

                <div class="result-section" id="result-display">
                    <p class="placeholder-text">Analysis results will appear here.</p>
                </div>
            </section>
        </main>
        
        <!-- Group Sidebar -->
        <aside class="sidebar" id="group-sidebar">
            <h2 id="sidebar-group-name">Group</h2>
            <p>Share this ID with friends:</p>
            <div id="group-id-display" title="Click to copy"></div>
            <div class="divider" style="width:100%"></div>
            <ul id="group-leaderboard"></ul>
            <button class="btn secondary" id="leave-group-btn">Leave Group</button>
        </aside>

        <button class="sidebar-toggle" id="sidebar-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
            </svg>
        </button>

        <!-- Modals -->
        <div class="modal-overlay" id="add-food-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Custom Food</h2>
                    <button class="close-modal-btn">&times;</button>
                </div>
                <form id="add-food-form">
                    <div class="form-group full-width">
                        <label for="food-name">Food Name</label>
                        <input type="text" id="food-name" required>
                    </div>
                    <div class="form-group">
                        <label for="food-calories">Calories</label>
                        <input type="number" id="food-calories" required min="0">
                    </div>
                    <div class="form-group">
                        <label for="food-points">Points</label>
                        <input type="number" id="food-points" required>
                    </div>
                     <div class="form-group">
                        <label for="food-protein">Protein (g)</label>
                        <input type="number" id="food-protein" required min="0" step="0.1">
                    </div>
                     <div class="form-group">
                        <label for="food-fat">Fat (g)</label>
                        <input type="number" id="food-fat" required min="0" step="0.1">
                    </div>
                     <div class="form-group">
                        <label for="food-carbs">Carbs (g)</label>
                        <input type="number" id="food-carbs" required min="0" step="0.1">
                    </div>
                    <button type="submit" class="btn">Save Food</button>
                </form>
            </div>
        </div>
        
        <div class="modal-overlay" id="group-modal">
            <div class="modal-content">
                <h2>Welcome to KaiZen!</h2>
                <p>To compete with friends, create a group or join an existing one.</p>
                <form id="group-form">
                    <div class="form-group full-width">
                        <label for="user-name">Your Name</label>
                        <input type="text" id="user-name" placeholder="Enter your display name" required>
                    </div>
                     <div class="form-group full-width">
                        <label for="group-name">New Group Name</label>
                        <input type="text" id="group-name" placeholder="e.g., Office Health Challenge">
                    </div>
                    <button type="button" class="btn" id="create-group-btn">Create Group</button>
                    
                    <div class="divider"></div>

                    <div class="form-group full-width">
                         <label for="group-id-input">Existing Group ID</label>
                        <input type="text" id="group-id-input" placeholder="Paste Group ID here">
                    </div>
                    <button type="button" class="btn secondary" id="join-group-btn">Join Group</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // This config is provided by the environment.
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyD_0TyJMQZEqcCEUAe3qt7-mlqp35-gqao",
          authDomain: "mykaizenapp2.firebaseapp.com",
          projectId: "mykaizenapp2",
          storageBucket: "mykaizenapp2.firebasestorage.app",
          messagingSenderId: "28975144198",
          appId: "1:28975144198:web:76512f4aab060e2ea9d287",
          measurementId: "G-KY6XRFDE9Z"
        };
        const appId = "mykainapp2"; // Used for Firestore paths
        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userProfile = { totalScore: 0, userName: '', currentGroupId: null, customFoods: {} };
        let groupMembers = [];
        let unsubscribeGroupListener = null;
        let loadingTimeout;

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContent = document.getElementById('main-content');
        const totalScoreEl = document.getElementById('total-score');
        const imageUploadEl = document.getElementById('image-upload');
        const imagePreviewEl = document.getElementById('image-preview');
        const placeholderTextEl = document.getElementById('placeholder-text');
        const resultDisplayEl = document.getElementById('result-display');
        const sidebar = document.getElementById('group-sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const foodSelectEl = document.getElementById('food-select');
        const logSelectedFoodBtn = document.getElementById('log-selected-food-btn');
        const addCustomFoodBtn = document.getElementById('add-custom-food-btn');
        const addFoodModal = document.getElementById('add-food-modal');
        const addFoodForm = document.getElementById('add-food-form');
        const groupModal = document.getElementById('group-modal');
        const createGroupBtn = document.getElementById('create-group-btn');
        const joinGroupBtn = document.getElementById('join-group-btn');
        const sidebarGroupName = document.getElementById('sidebar-group-name');
        const groupIdDisplay = document.getElementById('group-id-display');
        const groupLeaderboard = document.getElementById('group-leaderboard');
        const leaveGroupBtn = document.getElementById('leave-group-btn');
        
        // --- DATABASE (Default Foods) ---
        const nutritionDB = {
            'banana': { calories: 105, protein: 1.3, fat: 0.4, carbs: 27, points: 5 },
            'egg': { calories: 78, protein: 6.3, fat: 5.3, carbs: 0.6, points: 7 },
            'chicken': { calories: 165, protein: 31, fat: 3.6, carbs: 0, points: 8 },
            'pizza': { calories: 285, protein: 12, fat: 10, carbs: 36, points: -3 },
            'bread': { calories: 67, protein: 2, fat: 1, carbs: 13, points: 1 },
            'mango': { calories: 150, protein: 1.4, fat: 0.6, carbs: 38, points: 5 },
            'apple': { calories: 95, protein: 0.5, fat: 0.3, carbs: 25, points: 5 },
            'hamburger': { calories: 303, protein: 15, fat: 14, carbs: 28, points: -5 },
            'salad': { calories: 150, protein: 5, fat: 8, carbs: 15, points: 10 },
            'broccoli': { calories: 55, protein: 3.7, fat: 0.6, carbs: 11, points: 10 },
            'soda': { calories: 140, protein: 0, fat: 0, carbs: 39, points: -8 },
            'salmon': { calories: 206, protein: 22, fat: 12, carbs: 0, points: 10 },
            'trout': { calories: 190, protein: 21, fat: 11, carbs: 0, points: 10 },
            'sardines': { calories: 208, protein: 25, fat: 11, carbs: 0, points: 9 },
            'beans': { calories: 132, protein: 9, fat: 0.5, carbs: 24, points: 6 },
            'nuts': { calories: 579, protein: 21, fat: 50, carbs: 22, points: 4 },
            'avocado': { calories: 160, protein: 2, fat: 15, carbs: 9, points: 7 },
            'spinach': { calories: 23, protein: 2.9, fat: 0.4, carbs: 3.6, points: 10 },
            'potato': { calories: 93, protein: 2, fat: 0.1, carbs: 21, points: 3 },
            'pork': { calories: 242, protein: 27, fat: 14, carbs: 0, points: 2 },
            'lentils': { calories: 116, protein: 9, fat: 0.4, carbs: 20, points: 8 },
            'chickpeas': { calories: 139, protein: 7.6, fat: 2.4, carbs: 23, points: 7 },
        };
        const getCombinedDB = function() { return Object.assign({}, nutritionDB, userProfile.customFoods); };

        // --- UI UPDATE FUNCTIONS ---
        function showNotification(message, isError) {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            notification.className = 'notification';
            if (isError) {
                notification.classList.add('error');
            }
            notification.textContent = message;
            notificationArea.appendChild(notification);
            setTimeout(function() {
                notification.remove();
            }, 3500);
        };
        const updateScoreDisplay = function() { totalScoreEl.textContent = userProfile.totalScore || 0; };
        const showLoader = function() { resultDisplayEl.innerHTML = '<div class="loader"></div><p>Analyzing your meal...</p>'; };
        const displayError = function(message) { resultDisplayEl.innerHTML = '<p>' + message + '</p>'; };
        
        const populateFoodSelect = function() {
            foodSelectEl.innerHTML = '';
            const combinedDB = getCombinedDB();
            const sortedFoodNames = Object.keys(combinedDB).sort();
            sortedFoodNames.forEach(function(foodName) {
                const option = document.createElement('option');
                option.value = foodName;
                option.textContent = foodName.charAt(0).toUpperCase() + foodName.slice(1);
                foodSelectEl.appendChild(option);
            });
        };

        const renderLeaderboard = function() {
            groupLeaderboard.innerHTML = '';
            if (!groupMembers) return;
            const sortedMembers = [].slice.call(groupMembers).sort(function(a, b) { return b.score - a.score; });
            sortedMembers.forEach(function(member) {
                const li = document.createElement('li');
                if (member.id === currentUser.uid) {
                    li.classList.add('is-user');
                }
                li.innerHTML = '<span>' + member.userName + '</span><span>' + member.score + '</span>';
                groupLeaderboard.appendChild(li);
            });
        };

        const displayResults = function(foodName, nutritionData) {
            const points = nutritionData.points;
            const pointsColor = points >= 0 ? 'var(--accent-color)' : 'var(--negative-color)';
            const sign = points >= 0 ? '+' : '';
            resultDisplayEl.innerHTML = '<h3 id="result-food-name">' + foodName + '</h3>' +
                '<div class="nutrition-grid">' +
                    '<div class="nutrition-item"><div class="label">Calories</div><div class="value">' + nutritionData.calories + '</div></div>' +
                    '<div class="nutrition-item"><div class="label">Protein</div><div class="value">' + nutritionData.protein + 'g</div></div>' +
                    '<div class="nutrition-item"><div class="label">Fat</div><div class="value">' + nutritionData.fat + 'g</div></div>' +
                    '<div class="nutrition-item"><div class="label">Carbs</div><div class="value">' + nutritionData.carbs + 'g</div></div>' +
                '</div>' +
                '<div id="result-points" style="color: ' + pointsColor + '; background-color: ' + pointsColor + '20;">Meal Score: ' + sign + points + '</div>';
        };
        
        // --- CORE LOGIC & FIRESTORE INTERACTIONS ---
        function hideLoadingOverlay() {
            clearTimeout(loadingTimeout);
            loadingOverlay.classList.remove('visible');
        }
        
        async function initializeAuth() {
            onAuthStateChanged(auth, async function(user) {
                if (user) {
                    currentUser = user;
                    const userRef = doc(db, 'artifacts/' + appId + '/users/' + user.uid);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        userProfile = userSnap.data();
                        if (!userProfile.customFoods) userProfile.customFoods = {}; // Ensure customFoods exists
                        if (userProfile.currentGroupId) {
                            await setupGroupSession(userProfile.currentGroupId);
                            groupModal.classList.remove('visible');
                        } else {
                            groupModal.classList.add('visible');
                        }
                    } else {
                        groupModal.classList.add('visible');
                    }
                    updateScoreDisplay();
                    populateFoodSelect();
                    hideLoadingOverlay();
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                hideLoadingOverlay();
            }
        }
        
        loadingTimeout = setTimeout(function() {
            if (loadingOverlay.classList.contains('visible')) {
                hideLoadingOverlay();
                displayError("Failed to connect. Please check your internet connection and refresh.");
                showNotification("Error: Connection timed out.", true);
            }
        }, 10000);

        initializeAuth();

        async function setupGroupSession(groupId) {
            const groupRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + groupId);
            const groupSnap = await getDoc(groupRef);
            if (!groupSnap.exists()) {
                await handleLeaveGroup();
                return;
            }

            const groupData = groupSnap.data();
            sidebarGroupName.textContent = groupData.groupName;
            groupIdDisplay.textContent = groupId;
            userProfile.currentGroupId = groupId;

            const membersRef = collection(db, 'artifacts/' + appId + '/public/data/groups/' + groupId + '/members');
            if (unsubscribeGroupListener) unsubscribeGroupListener();
            
            unsubscribeGroupListener = onSnapshot(membersRef, function(snapshot) {
                groupMembers = snapshot.docs.map(function(d) { return Object.assign({ id: d.id }, d.data()); });
                renderLeaderboard();
            });
        }
        
        async function updateScoreInFirestore(points) {
            if (!currentUser || !userProfile.currentGroupId) return;
            userProfile.totalScore += points;
            updateScoreDisplay();

            const userRef = doc(db, 'artifacts/' + appId + '/users/' + currentUser.uid);
            const memberRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + userProfile.currentGroupId + '/members/' + currentUser.uid);

            const batch = writeBatch(db);
            batch.update(userRef, { totalScore: userProfile.totalScore });
            batch.update(memberRef, { score: userProfile.totalScore });
            await batch.commit();
        }

        const processFoodResult = function(foodIdentifier) {
            const foodItems = foodIdentifier.split(',').map(function(item) { return item.trim().toLowerCase(); });
            const combinedDB = getCombinedDB();
            let foundFood = null;

            for (let i = 0; i < foodItems.length; i++) {
                if (combinedDB[foodItems[i]]) {
                    foundFood = foodItems[i];
                    break;
                }
            }
            
            if (foundFood) {
                const nutritionData = combinedDB[foundFood];
                displayResults(foundFood, nutritionData);
                updateScoreInFirestore(nutritionData.points);
            } else {
                displayError('Sorry, nutrition info for "' + foodItems[0] + '" is not available.');
            }
        };

        const handleImageUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreviewEl.src = e.target.result;
                imagePreviewEl.style.display = 'block';
                placeholderTextEl.style.display = 'none';
                const base64Image = e.target.result.split(',')[1];
                analyzeImage(base64Image);
            };
            reader.readAsDataURL(file);
        };

        const analyzeImage = async function(base64ImageData) {
            showLoader();
            const apiKey = "AIzaSyCvpYIwcYTUiMdnCs_4wSga6Ftw0e1JvNQ"; // The environment injects the key.
            const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=' + apiKey;
            const payload = {
                contents: [{
                    parts: [
                        { text: "Identify the primary food item in this photo. Return only the name of the food in lowercase. If multiple items, list the 2 most prominent separated by a comma. Be concise." },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }]
            };

            try {
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    var errorMessage = "The API returned an unspecified error.";
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMessage = errorData.error.message;
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                var foodText = null;
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    foodText = data.candidates[0].content.parts[0].text;
                }

                if (foodText) {
                    processFoodResult(foodText.trim());
                } else {
                     throw new Error("Could not identify food from image.");
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                displayError("Failed to analyze image: " + error.message);
            }
        };


        // --- GROUP MANAGEMENT ---
        createGroupBtn.addEventListener('click', async function() {
            const userName = document.getElementById('user-name').value.trim();
            const groupName = document.getElementById('group-name').value.trim();
            if (!userName || !groupName) {
                showNotification("Please enter both your name and a group name.", true);
                return;
            }
            
            createGroupBtn.disabled = true;
            joinGroupBtn.disabled = true;

            const groupsCollection = collection(db, 'artifacts/' + appId + '/public/data/groups');
            const groupId = doc(groupsCollection).id;
            const userRef = doc(db, 'artifacts/' + appId + '/users/' + currentUser.uid);
            const groupRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + groupId);
            const memberRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + groupId + '/members/' + currentUser.uid);

            userProfile.userName = userName;
            userProfile.totalScore = 0;
            userProfile.currentGroupId = groupId;
            
            const batch = writeBatch(db);
            batch.set(userRef, userProfile);
            batch.set(groupRef, { groupName: groupName, createdAt: new Date() });
            batch.set(memberRef, { userName: userProfile.userName, score: userProfile.totalScore });

            await batch.commit();
            await setupGroupSession(groupId);
            groupModal.classList.remove('visible');
            createGroupBtn.disabled = false;
            joinGroupBtn.disabled = false;
        });

        joinGroupBtn.addEventListener('click', async function() {
            const userName = document.getElementById('user-name').value.trim();
            const groupId = document.getElementById('group-id-input').value.trim();
            if (!userName || !groupId) {
                showNotification("Please enter both your name and a Group ID.", true);
                return;
            }

            createGroupBtn.disabled = true;
            joinGroupBtn.disabled = true;

            const groupRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + groupId);
            const groupSnap = await getDoc(groupRef);

            if (groupSnap.exists()) {
                const userRef = doc(db, 'artifacts/' + appId + '/users/' + currentUser.uid);
                const memberRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + groupId + '/members/' + currentUser.uid);
                
                userProfile.userName = userName;
                userProfile.totalScore = 0;
                userProfile.currentGroupId = groupId;

                const batch = writeBatch(db);
                batch.set(userRef, userProfile);
                batch.set(memberRef, { userName: userProfile.userName, score: userProfile.totalScore });
                
                await batch.commit();
                await setupGroupSession(groupId);
                groupModal.classList.remove('visible');
            } else {
                showNotification("Group not found. Please check the ID.", true);
            }
            createGroupBtn.disabled = false;
            joinGroupBtn.disabled = false;
        });

        async function handleLeaveGroup() {
            if (!currentUser || !userProfile.currentGroupId) return;

            if (unsubscribeGroupListener) unsubscribeGroupListener();
            unsubscribeGroupListener = null;

            const memberRef = doc(db, 'artifacts/' + appId + '/public/data/groups/' + userProfile.currentGroupId + '/members/' + currentUser.uid);
            await deleteDoc(memberRef);

            const userRef = doc(db, 'artifacts/' + appId + '/users/' + currentUser.uid);
            userProfile.currentGroupId = null;
            await updateDoc(userRef, { currentGroupId: null });

            sidebar.classList.remove('open');
            mainContent.classList.remove('sidebar-open');
            groupModal.classList.add('visible');
        }
        leaveGroupBtn.addEventListener('click', handleLeaveGroup);

        // --- CUSTOM FOOD & OTHER LISTENERS ---
        document.querySelectorAll('.close-modal-btn').forEach(function(btn) {
             btn.addEventListener('click', function() {
                addFoodModal.classList.remove('visible');
            });
        });
        logSelectedFoodBtn.addEventListener('click', function() { processFoodResult(foodSelectEl.value) });
        addCustomFoodBtn.addEventListener('click', function() { addFoodModal.classList.add('visible') });
        imageUploadEl.addEventListener('change', handleImageUpload);
        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('open');
            mainContent.classList.toggle('sidebar-open');
        });
        groupIdDisplay.addEventListener('click', function() {
            navigator.clipboard.writeText(groupIdDisplay.textContent);
            showNotification("Group ID copied to clipboard!");
        });
        
        addFoodForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('food-name').value.trim().toLowerCase();
            if (!name) return;

            const customFoodData = {
                calories: parseFloat(document.getElementById('food-calories').value),
                protein: parseFloat(document.getElementById('food-protein').value),
                fat: parseFloat(document.getElementById('food-fat').value),
                carbs: parseFloat(document.getElementById('food-carbs').value),
                points: parseInt(document.getElementById('food-points').value, 10)
            };
            userProfile.customFoods[name] = customFoodData;
            
            const userRef = doc(db, 'artifacts/' + appId + '/users/' + currentUser.uid);
            await updateDoc(userRef, { customFoods: userProfile.customFoods });
            
            populateFoodSelect();
            addFoodForm.reset();
            addFoodModal.classList.remove('visible');
        });

    </script>
</body>
</html>


